<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CLINILAB - Sua Sa√∫de Visual</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
        import { getAuth, signInAnonymously } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
        import { getFirestore, doc, setDoc, getDoc, collection, query, where, getDocs } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';

        // -----------------------------------------------------------
        // CONFIGURA√á√ÉO FIREBASE - COLE SUAS CHAVES AQUI
        // -----------------------------------------------------------
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        // Se estiver rodando localmente sem as vari√°veis de ambiente, descomente e preencha abaixo:
        /*
        const firebaseConfig = {
            apiKey: "SUA_API_KEY",
            authDomain: "SEU_PROJETO.firebaseapp.com",
            projectId: "SEU_PROJETO",
            storageBucket: "...",
            messagingSenderId: "...",
            appId: "..."
        };
        */
        const appId = 'clinilab-2026-v1';

        let db, auth;

        async function initSystem() {
            if (!firebaseConfig.apiKey) {
                console.warn("Firebase n√£o configurado. O agendamento n√£o salvar√° bloqueios.");
                return;
            }
            const app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            await signInAnonymously(auth);
            console.log("Sistema Conectado");
        }
        initSystem();

        // Vari√°veis Globais
        window.selectedProf = null;
        window.selectedDate = null;
        window.selectedTime = null;
        window.db = db; // Expor para fun√ß√µes globais

        // Profissionais
        const professionals = [
            { id: 'cleide', name: 'Cleide Rosa', role: 'Optometrista', price: 120.00 },
            { id: 'joao', name: 'Joao Carlos', role: 'Optometrista', price: 120.00 },
            { id: 'guilherme', name: 'Guilherme Arantes', role: 'Optometrista', price: 120.00 },
            { id: 'eduardo', name: 'Dr. Eduardo Sodr√©', role: 'Oftalmologista', price: 180.00 }
        ];

        // Feriados 2026 (Exemplo de principais feriados nacionais)
        const holidays2026 = [
            '2026-01-01', // Ano Novo
            '2026-02-17', // Carnaval
            '2026-04-03', // Sexta Santa
            '2026-04-21', // Tiradentes
            '2026-05-01', // Trabalho
            '2026-06-04', // Corpus Christi
            '2026-09-07', // Independ√™ncia
            '2026-10-12', // Padroeira
            '2026-11-02', // Finados
            '2026-11-15', // Rep√∫blica
            '2026-12-25'  // Natal
        ];

        // --- FUN√á√ïES DE L√ìGICA ---

        window.selectProfessional = (id) => {
            window.selectedProf = professionals.find(p => p.id === id);
            
            // UI Update
            document.querySelectorAll('.prof-card').forEach(el => el.classList.remove('ring-4', 'ring-blue-500', 'bg-blue-50'));
            document.getElementById(`card-${id}`).classList.add('ring-4', 'ring-blue-500', 'bg-blue-50');
            
            document.getElementById('step-2').classList.remove('hidden');
            document.getElementById('step-2').scrollIntoView({ behavior: 'smooth' });
            
            // Reset Date if exists
            if(window.selectedDate) window.loadSlots();
        };

        window.handleDateChange = () => {
            const input = document.getElementById('date-input');
            const date = new Date(input.value + 'T00:00:00'); // Force local time
            
            // Valida√ß√µes de Bloqueio (Domingo, Feriado)
            const dayOfWeek = date.getDay(); // 0 = Domingo
            const dateString = input.value;

            const errorEl = document.getElementById('date-error');
            errorEl.classList.add('hidden');
            document.getElementById('slots-container').innerHTML = '';

            if (dayOfWeek === 0) {
                errorEl.innerText = "N√£o atendemos aos Domingos.";
                errorEl.classList.remove('hidden');
                return;
            }

            if (holidays2026.includes(dateString)) {
                errorEl.innerText = "Esta data √© um feriado nacional.";
                errorEl.classList.remove('hidden');
                return;
            }

            window.selectedDate = dateString;
            window.loadSlots();
        };

        window.loadSlots = async () => {
            if(!window.selectedProf || !window.selectedDate) return;

            const container = document.getElementById('slots-container');
            container.innerHTML = '<p class="text-gray-500 col-span-3 text-center">Carregando hor√°rios...</p>';

            // Hor√°rios Base: 08:00 as 18:00 (Fim do √∫ltimo atendimento 17:30)
            const slots = [];
            for (let h = 8; h < 18; h++) {
                slots.push(`${h < 10 ? '0'+h : h}:00`);
                slots.push(`${h < 10 ? '0'+h : h}:30`);
            }

            // Regra S√°bado (Bloqueio ap√≥s 13:00)
            const dateObj = new Date(window.selectedDate + 'T00:00:00');
            if (dateObj.getDay() === 6) { // S√°bado
                // Remove slots ap√≥s 12:30 (para terminar 13:00)
                const saturdayLimitIndex = slots.indexOf("13:00");
                if (saturdayLimitIndex > -1) {
                    slots.splice(saturdayLimitIndex); 
                }
            }

            // Busca agendamentos no Firebase
            let takenSlots = [];
            if (window.db) {
                // ID do documento no banco: PROFISSIONAL_DATA_HORA
                // Vamos buscar todos documentos que come√ßam com PROFISSIONAL_DATA
                try {
                    const q = query(
                        collection(window.db, 'appointments'),
                        where("profId", "==", window.selectedProf.id),
                        where("date", "==", window.selectedDate)
                    );
                    const querySnapshot = await getDocs(q);
                    querySnapshot.forEach((doc) => {
                        takenSlots.push(doc.data().time);
                    });
                } catch (e) {
                    console.error("Erro ao buscar agenda:", e);
                }
            }

            // Renderiza
            container.innerHTML = '';
            const isAdminMode = document.getElementById('admin-toggle').checked;

            slots.forEach(time => {
                const isTaken = takenSlots.includes(time);
                const btn = document.createElement('button');
                btn.className = `p-3 rounded-lg text-sm font-bold border transition-all ${
                    isTaken 
                    ? 'bg-red-100 text-red-400 cursor-not-allowed border-red-200' 
                    : 'bg-white hover:bg-blue-500 hover:text-white border-gray-200 text-gray-700'
                }`;
                
                if (isTaken) {
                    btn.innerText = isAdminMode ? `${time} (X)` : "Ocupado";
                    btn.disabled = !isAdminMode; // Admin pode clicar para desbloquear (l√≥gica futura)
                    if(isAdminMode) {
                        btn.onclick = () => alert("Para desbloquear, entre em contato com o suporte t√©cnico.");
                    }
                } else {
                    btn.innerText = time;
                    btn.onclick = () => window.selectTime(time, btn);
                }
                
                container.appendChild(btn);
            });
            
            document.getElementById('step-3').classList.remove('hidden');
        };

        window.selectTime = (time, btnElement) => {
            window.selectedTime = time;
            
            // Visual Highlight
            document.querySelectorAll('#slots-container button').forEach(b => {
                if(!b.disabled) b.className = 'p-3 rounded-lg text-sm font-bold border bg-white border-gray-200 text-gray-700';
            });
            btnElement.className = 'p-3 rounded-lg text-sm font-bold border bg-blue-600 text-white border-blue-600 shadow-lg scale-105';
            
            // Se modo admin estiver ativado, bloqueia imediatamente
            const isAdminMode = document.getElementById('admin-toggle').checked;
            if (isAdminMode) {
                window.blockSlotManual();
            } else {
                document.getElementById('step-4').classList.remove('hidden');
                document.getElementById('step-4').scrollIntoView({ behavior: 'smooth' });
            }
        };

        // Bloqueio Manual (Admin)
        window.blockSlotManual = async () => {
            if(!confirm(`Deseja bloquear a agenda de ${window.selectedProf.name} √†s ${window.selectedTime}?`)) return;
            
            await window.saveAppointment({
                name: "BLOQUEIO MANUAL",
                phone: "ADMIN",
                cpf: "ADMIN",
                address: "ADMIN"
            }, true);
            
            alert("Hor√°rio Bloqueado com Sucesso!");
            window.loadSlots(); // Recarrega
        };

        // Finalizar Agendamento
        window.finishBooking = async (e) => {
            e.preventDefault();
            const btn = document.getElementById('btn-confirm');
            
            const clientData = {
                name: document.getElementById('client-name').value,
                cpf: document.getElementById('client-cpf').value,
                phone: document.getElementById('client-phone').value,
                address: document.getElementById('client-address').value
            };

            if(!clientData.name || !clientData.phone) {
                alert("Preencha pelo menos Nome e Telefone.");
                return;
            }

            btn.innerText = "Processando...";
            btn.disabled = true;

            // 1. Salvar no Firebase
            await window.saveAppointment(clientData, false);

            // 2. Redirecionar WhatsApp
            const msg = `Ol√°, gostaria de confirmar meu agendamento na CLINILAB.%0A%0A*Profissional:* ${window.selectedProf.name} (${window.selectedProf.role})%0A*Valor:* R$ ${window.selectedProf.price.toFixed(2)}%0A*Data:* ${window.selectedDate.split('-').reverse().join('/')}%0A*Hor√°rio:* ${window.selectedTime}%0A%0A*Meus Dados:*%0ANome: ${clientData.name}%0ACPF: ${clientData.cpf}%0ATelefone: ${clientData.phone}%0AEndere√ßo: ${clientData.address}`;
            
            window.open(`https://wa.me/5541996509734?text=${msg}`, '_blank');
            
            // Reset UI
            alert("Agendamento iniciado! Finalize a conversa no WhatsApp.");
            location.reload();
        };

        window.saveAppointment = async (clientData, isBlock) => {
            if (!window.db) return;
            
            const docId = `${window.selectedProf.id}_${window.selectedDate}_${window.selectedTime}`;
            
            try {
                await setDoc(doc(window.db, 'appointments', docId), {
                    profId: window.selectedProf.id,
                    profName: window.selectedProf.name,
                    date: window.selectedDate,
                    time: window.selectedTime,
                    client: clientData,
                    type: isBlock ? 'block' : 'appointment',
                    createdAt: new Date().toISOString()
                });
            } catch (e) {
                console.error("Erro ao salvar:", e);
                alert("Houve um erro ao reservar o hor√°rio. Tente novamente.");
            }
        };

    </script>

    <style>
        body { font-family: 'Montserrat', sans-serif; background-color: #f8fafc; }
        .hero-pattern {
            background-color: #0f172a;
            background-image: url("https://images.unsplash.com/photo-1623875323214-996459392e21?q=80&w=1920&auto=format&fit=crop");
            background-size: cover;
            background-position: center;
            background-blend-mode: overlay;
        }
        /* Efeito de vidro */
        .glass {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
    </style>
</head>
<body class="text-slate-800">

    <!-- HERO SECTION -->
    <header class="hero-pattern h-[500px] flex items-center justify-center relative shadow-2xl">
        <div class="absolute inset-0 bg-gradient-to-t from-slate-900 to-transparent opacity-90"></div>
        
        <div class="container mx-auto px-6 relative z-10 text-center text-white">
            <h2 class="text-lg font-semibold tracking-widest text-blue-400 mb-2">BEM-VINDO √Ä</h2>
            <h1 class="text-6xl font-bold mb-4 tracking-tight">CLINILAB</h1>
            <p class="text-xl font-light italic opacity-90 mb-8">"Sua sa√∫de visual √© a nossa prioridade"</p>
            <a href="#agendamento" class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 px-8 rounded-full shadow-lg transition-all transform hover:scale-105">
                Agendar Consulta Online
            </a>
        </div>
    </header>

    <!-- ADMIN TOGGLE (Discreto) -->
    <div class="bg-slate-800 text-white py-2 px-6 flex justify-end items-center gap-3 text-xs">
        <span>Modo Admin (Fechar Agenda):</span>
        <label class="relative inline-flex items-center cursor-pointer">
            <input type="checkbox" id="admin-toggle" class="sr-only peer" onchange="window.loadSlots()">
            <div class="w-9 h-5 bg-gray-600 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-red-600"></div>
        </label>
    </div>

    <!-- MAIN APP -->
    <main id="agendamento" class="container mx-auto px-4 py-12 -mt-20 relative z-20">
        
        <div class="glass rounded-3xl shadow-2xl overflow-hidden p-8 max-w-4xl mx-auto">
            
            <!-- STEP 1: PROFISSIONAL -->
            <div class="mb-10">
                <div class="flex items-center gap-4 mb-6">
                    <div class="w-10 h-10 rounded-full bg-blue-600 text-white flex items-center justify-center font-bold">1</div>
                    <h3 class="text-xl font-bold text-slate-800">Escolha o Profissional</h3>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    <!-- Cards gerados dinamicamente via JS -->
                    <div id="card-cleide" onclick="selectProfessional('cleide')" class="prof-card cursor-pointer border rounded-xl p-4 hover:shadow-lg transition-all text-center">
                        <div class="w-16 h-16 bg-slate-200 rounded-full mx-auto mb-3 flex items-center justify-center text-2xl">üë©üèæ‚Äç‚öïÔ∏è</div>
                        <h4 class="font-bold text-slate-800">Cleide Rosa</h4>
                        <p class="text-xs text-slate-500 uppercase">Optometrista</p>
                        <p class="text-blue-600 font-bold mt-2">R$ 120,00</p>
                    </div>
                    <div id="card-joao" onclick="selectProfessional('joao')" class="prof-card cursor-pointer border rounded-xl p-4 hover:shadow-lg transition-all text-center">
                        <div class="w-16 h-16 bg-slate-200 rounded-full mx-auto mb-3 flex items-center justify-center text-2xl">üë®üèª‚Äç‚öïÔ∏è</div>
                        <h4 class="font-bold text-slate-800">Joao Carlos</h4>
                        <p class="text-xs text-slate-500 uppercase">Optometrista</p>
                        <p class="text-blue-600 font-bold mt-2">R$ 120,00</p>
                    </div>
                    <div id="card-guilherme" onclick="selectProfessional('guilherme')" class="prof-card cursor-pointer border rounded-xl p-4 hover:shadow-lg transition-all text-center">
                        <div class="w-16 h-16 bg-slate-200 rounded-full mx-auto mb-3 flex items-center justify-center text-2xl">üë®üèΩ‚Äç‚öïÔ∏è</div>
                        <h4 class="font-bold text-slate-800">Guilherme Arantes</h4>
                        <p class="text-xs text-slate-500 uppercase">Optometrista</p>
                        <p class="text-blue-600 font-bold mt-2">R$ 120,00</p>
                    </div>
                    <div id="card-eduardo" onclick="selectProfessional('eduardo')" class="prof-card cursor-pointer border rounded-xl p-4 hover:shadow-lg transition-all text-center border-blue-100 bg-blue-50/50">
                        <div class="w-16 h-16 bg-blue-100 rounded-full mx-auto mb-3 flex items-center justify-center text-2xl">üë®üèª‚Äç‚öïÔ∏è</div>
                        <h4 class="font-bold text-slate-800">Dr. Eduardo Sodr√©</h4>
                        <p class="text-xs text-slate-500 uppercase">Oftalmologista</p>
                        <p class="text-blue-600 font-bold mt-2">R$ 180,00</p>
                    </div>
                </div>
            </div>

            <!-- STEP 2: DATA -->
            <div id="step-2" class="mb-10 hidden">
                <div class="flex items-center gap-4 mb-6">
                    <div class="w-10 h-10 rounded-full bg-blue-600 text-white flex items-center justify-center font-bold">2</div>
                    <h3 class="text-xl font-bold text-slate-800">Selecione a Data (2026)</h3>
                </div>
                
                <div class="max-w-xs">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Data da Consulta</label>
                    <input type="date" id="date-input" onchange="handleDateChange()" min="2026-01-01" max="2026-12-31" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                    <p id="date-error" class="text-red-500 text-sm mt-2 hidden font-bold"></p>
                </div>
            </div>

            <!-- STEP 3: HOR√ÅRIO -->
            <div id="step-3" class="mb-10 hidden">
                <div class="flex items-center gap-4 mb-6">
                    <div class="w-10 h-10 rounded-full bg-blue-600 text-white flex items-center justify-center font-bold">3</div>
                    <h3 class="text-xl font-bold text-slate-800">Hor√°rio Dispon√≠vel</h3>
                </div>
                
                <div id="slots-container" class="grid grid-cols-4 sm:grid-cols-6 md:grid-cols-8 gap-3">
                    <!-- Slots injetados via JS -->
                </div>
            </div>

            <!-- STEP 4: DADOS E CONFIRMA√á√ÉO -->
            <div id="step-4" class="hidden border-t border-gray-200 pt-8">
                <div class="flex items-center gap-4 mb-6">
                    <div class="w-10 h-10 rounded-full bg-green-600 text-white flex items-center justify-center font-bold">4</div>
                    <h3 class="text-xl font-bold text-slate-800">Seus Dados</h3>
                </div>

                <form onsubmit="finishBooking(event)" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="col-span-2 md:col-span-1">
                        <label class="block text-xs font-bold text-gray-500 uppercase">Nome Completo</label>
                        <input type="text" id="client-name" required class="w-full p-3 border rounded-lg bg-gray-50">
                    </div>
                    <div class="col-span-2 md:col-span-1">
                        <label class="block text-xs font-bold text-gray-500 uppercase">CPF</label>
                        <input type="text" id="client-cpf" placeholder="000.000.000-00" class="w-full p-3 border rounded-lg bg-gray-50">
                    </div>
                    <div class="col-span-2">
                        <label class="block text-xs font-bold text-gray-500 uppercase">Endere√ßo</label>
                        <input type="text" id="client-address" class="w-full p-3 border rounded-lg bg-gray-50">
                    </div>
                    <div class="col-span-2 md:col-span-1">
                        <label class="block text-xs font-bold text-gray-500 uppercase">Telefone / WhatsApp</label>
                        <input type="tel" id="client-phone" required placeholder="(41) 99999-9999" class="w-full p-3 border rounded-lg bg-gray-50">
                    </div>

                    <div class="col-span-2 mt-4">
                        <button type="submit" id="btn-confirm" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-4 rounded-xl shadow-lg transition-transform transform hover:scale-[1.01] flex items-center justify-center gap-3">
                            <span>‚úÖ Confirmar no WhatsApp</span>
                        </button>
                        <p class="text-xs text-center text-gray-400 mt-2">Ao clicar, voc√™ ser√° redirecionado para enviar os dados.</p>
                    </div>
                </form>
            </div>

        </div>

    </main>

    <footer class="bg-slate-900 text-slate-400 py-8 text-center mt-12">
        <p class="text-sm">CLINILAB &copy; 2026. Todos os direitos reservados.</p>
    </footer>

</body>
</html>