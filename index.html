<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CONSULT√ìRIO OLHARYS - Sua Sa√∫de Visual</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
        import { getFirestore, doc, setDoc, getDoc, collection, query, where, getDocs } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';

        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'olharys-2026-v4';

        let db, auth;

        async function initSystem() {
            if (!firebaseConfig.apiKey) {
                console.warn("Firebase n√£o configurado.");
                return;
            }
            const app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);

            // Autentica√ß√£o robusta conforme regras
            const initAuth = async () => {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            };
            await initAuth();
        }
        initSystem();

        window.selectedProf = null;
        window.selectedDate = null;
        window.selectedTime = null;

        const professionals = [
            { id: 'optometrista', name: 'OPTOMETRISTA', role: 'Exame de Vista', price: 120.00, icon: 'üëÅÔ∏è' },
            { id: 'oftalmologista', name: 'OFTALMOLOGISTA', role: 'Consulta M√©dica', price: 150.00, icon: 'üë®üèª‚Äç‚öïÔ∏è' }
        ];

        const holidays2026 = [
            '2026-01-01', '2026-02-17', '2026-04-03', '2026-04-21', 
            '2026-05-01', '2026-06-04', '2026-09-07', '2026-10-12', 
            '2026-11-02', '2026-11-15', '2026-12-25'
        ];

        window.selectProfessional = (id) => {
            window.selectedProf = professionals.find(p => p.id === id);
            document.querySelectorAll('.prof-card').forEach(el => el.classList.remove('ring-4', 'ring-teal-500', 'bg-teal-50'));
            document.getElementById(`card-${id}`).classList.add('ring-4', 'ring-teal-500', 'bg-teal-50');
            document.getElementById('step-2').classList.remove('hidden');
            document.getElementById('step-2').scrollIntoView({ behavior: 'smooth' });
            if(window.selectedDate) window.loadSlots();
        };

        window.handleDateChange = () => {
            const input = document.getElementById('date-input');
            const date = new Date(input.value + 'T00:00:00');
            const dayOfWeek = date.getDay();
            const dateString = input.value;
            const errorEl = document.getElementById('date-error');
            errorEl.classList.add('hidden');
            if (dayOfWeek === 0) {
                errorEl.innerText = "N√£o atendemos aos Domingos.";
                errorEl.classList.remove('hidden');
                return;
            }
            if (holidays2026.includes(dateString)) {
                errorEl.innerText = "Esta data √© um feriado nacional.";
                errorEl.classList.remove('hidden');
                return;
            }
            window.selectedDate = dateString;
            window.loadSlots();
        };

        window.loadSlots = async () => {
            if(!window.selectedProf || !window.selectedDate || !db) return;
            const container = document.getElementById('slots-container');
            container.innerHTML = '<p class="text-gray-500 col-span-3 text-center">Carregando hor√°rios...</p>';
            
            const slots = [];
            for (let h = 8; h < 18; h++) {
                slots.push(`${h < 10 ? '0'+h : h}:00`);
                slots.push(`${h < 10 ? '0'+h : h}:30`);
            }
            const dateObj = new Date(window.selectedDate + 'T00:00:00');
            if (dateObj.getDay() === 6) { // S√°bado atende at√© 13h
                const saturdayLimitIndex = slots.indexOf("13:00");
                if (saturdayLimitIndex > -1) slots.splice(saturdayLimitIndex); 
            }

            let takenSlots = [];
            try {
                const q = query(
                    collection(db, 'artifacts', appId, 'public', 'data', 'appointments'), 
                    where("profId", "==", window.selectedProf.id), 
                    where("date", "==", window.selectedDate)
                );
                const querySnapshot = await getDocs(q);
                querySnapshot.forEach((doc) => takenSlots.push(doc.data().time));
            } catch (e) { 
                console.error("Erro ao buscar hor√°rios:", e); 
            }

            container.innerHTML = '';
            const isAdminMode = document.getElementById('admin-toggle').checked;
            
            slots.forEach(time => {
                const isTaken = takenSlots.includes(time);
                const btn = document.createElement('button');
                btn.className = `p-3 rounded-lg text-sm font-bold border transition-all ${isTaken ? 'bg-red-100 text-red-400 cursor-not-allowed border-red-200' : 'bg-white hover:bg-teal-500 hover:text-white border-gray-200 text-gray-700'}`;
                if (isTaken) {
                    btn.innerText = isAdminMode ? `${time} (X)` : "Ocupado";
                    btn.disabled = !isAdminMode;
                } else {
                    btn.innerText = time;
                    btn.onclick = () => window.selectTime(time, btn);
                }
                container.appendChild(btn);
            });
            document.getElementById('step-3').classList.remove('hidden');
        };

        window.selectTime = (time, btnElement) => {
            window.selectedTime = time;
            document.querySelectorAll('#slots-container button').forEach(b => {
                if(!b.disabled) b.className = 'p-3 rounded-lg text-sm font-bold border bg-white border-gray-200 text-gray-700';
            });
            btnElement.className = 'p-3 rounded-lg text-sm font-bold border bg-teal-600 text-white border-teal-600 shadow-lg scale-105';
            
            const isAdminMode = document.getElementById('admin-toggle').checked;
            if (isAdminMode) {
                // L√≥gica de bloqueio r√°pido para admin
                if(confirm(`Deseja bloquear o hor√°rio ${time}?`)) {
                    window.saveAppointment({ name: 'BLOQUEADO', phone: 'N/A', city: 'N/A' }, true);
                }
            } else {
                document.getElementById('step-4').classList.remove('hidden');
                document.getElementById('step-4').scrollIntoView({ behavior: 'smooth' });
            }
        };

        window.finishBooking = async (e) => {
            e.preventDefault();
            const btn = document.getElementById('btn-confirm');
            const clientData = {
                name: document.getElementById('client-name').value,
                phone: document.getElementById('client-phone').value,
                city: document.getElementById('client-city').value
            };
            btn.innerText = "Agendando...";
            btn.disabled = true;

            await window.saveAppointment(clientData, false);
            
            const msg = `Ol√°, quero agendar no CONSULT√ìRIO OLHARYS.%0A%0A*Tipo:* ${window.selectedProf.name}%0A*Data:* ${window.selectedDate.split('-').reverse().join('/')}%0A*Hor√°rio:* ${window.selectedTime}%0A%0ANome: ${clientData.name}`;
            window.open(`https://wa.me/5541996509734?text=${msg}`, '_blank');
            location.reload();
        };

        window.saveAppointment = async (clientData, isBlock) => {
            if (!db) return;
            const docId = `${window.selectedProf.id}_${window.selectedDate}_${window.selectedTime}`;
            try {
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'appointments', docId), {
                    profId: window.selectedProf.id,
                    date: window.selectedDate,
                    time: window.selectedTime,
                    client: clientData,
                    type: isBlock ? 'block' : 'appointment',
                    createdAt: new Date().toISOString()
                });
                if(isBlock) location.reload();
            } catch (e) { console.error("Erro ao salvar:", e); }
        };
    </script>

    <style>
        body { font-family: 'Montserrat', sans-serif; background-color: #6CC0BA; }
        .hero-pattern {
            background-color: #0d5c56;
            background-image: url("https://images.unsplash.com/photo-1570222094114-2819cd595435?q=80&w=1920&auto=format&fit=crop");
            background-size: cover;
            background-position: center;
            background-blend-mode: overlay;
        }
        .glass {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.5);
        }
        .eye-icon {
            filter: drop-shadow(0px 4px 6px rgba(0,0,0,0.2));
        }
        input[type="date"]::-webkit-calendar-picker-indicator {
            cursor: pointer;
            filter: invert(0.5) sepia(1) saturate(5) hue-rotate(145deg);
        }
    </style>
</head>
<body class="text-slate-800">

    <!-- CABE√áALHO -->
    <header class="hero-pattern h-[550px] flex items-center justify-center relative shadow-2xl">
        <div class="absolute inset-0 bg-gradient-to-t from-[#6CC0BA] to-transparent opacity-90"></div>
        
        <div class="container mx-auto px-6 relative z-10 text-center text-white">
            <h2 class="text-lg font-semibold tracking-widest text-teal-100 mb-2 uppercase">Seja Bem-vindo ao</h2>
            <h1 class="text-5xl md:text-7xl font-bold tracking-tight">CONSULT√ìRIO OLHARYS</h1>
            
            <!-- √çCONE DE OLHO ABAIXO DO NOME -->
            <div class="flex justify-center mt-6 mb-6">
                <svg class="eye-icon w-20 h-20 md:w-24 md:h-24 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                </svg>
            </div>

            <p class="text-xl font-light italic opacity-90 mb-8 max-w-lg mx-auto">"Sua sa√∫de visual √© a nossa prioridade em cada detalhe."</p>
            
            <a href="#agendamento" class="bg-white hover:bg-teal-50 text-teal-700 font-bold py-4 px-10 rounded-full shadow-lg transition-all transform hover:scale-105 border-2 border-white inline-block">
                Agendar Agora
            </a>
        </div>
    </header>

    <!-- ADMIN TOGGLE (Para controle interno) -->
    <div class="bg-teal-900 text-white py-2 px-6 flex justify-end items-center gap-3 text-xs">
        <span>Admin (Bloquear Hor√°rio):</span>
        <label class="relative inline-flex items-center cursor-pointer">
            <input type="checkbox" id="admin-toggle" class="sr-only peer" onchange="window.loadSlots()">
            <div class="w-9 h-5 bg-teal-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-red-500"></div>
        </label>
    </div>

    <!-- MAIN APP -->
    <main id="agendamento" class="container mx-auto px-4 py-12 -mt-16 relative z-20">
        <div class="glass rounded-3xl shadow-2xl overflow-hidden p-8 max-w-4xl mx-auto">
            
            <!-- ETAPA 1: PROFISSIONAL -->
            <div class="mb-10">
                <div class="flex items-center gap-4 mb-6">
                    <div class="w-10 h-10 rounded-full bg-teal-600 text-white flex items-center justify-center font-bold">1</div>
                    <h3 class="text-xl font-bold text-slate-800">Tipo de Atendimento</h3>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div id="card-optometrista" onclick="selectProfessional('optometrista')" class="prof-card cursor-pointer border-2 border-teal-100 rounded-2xl p-6 hover:shadow-xl transition-all text-center group bg-white">
                        <div class="w-16 h-16 bg-teal-50 rounded-full mx-auto mb-4 flex items-center justify-center text-3xl group-hover:scale-110 transition-transform">üëÅÔ∏è</div>
                        <h4 class="text-lg font-bold">OPTOMETRISTA</h4>
                        <p class="text-sm text-gray-500 mb-2">Exame de Vista</p>
                        <div class="mt-2 text-teal-700 font-bold text-xl">R$ 120,00</div>
                    </div>
                    <div id="card-oftalmologista" onclick="selectProfessional('oftalmologista')" class="prof-card cursor-pointer border-2 border-teal-100 rounded-2xl p-6 hover:shadow-xl transition-all text-center group bg-white">
                        <div class="w-16 h-16 bg-teal-50 rounded-full mx-auto mb-4 flex items-center justify-center text-3xl group-hover:scale-110 transition-transform">üë®üèª‚Äç‚öïÔ∏è</div>
                        <h4 class="text-lg font-bold">OFTALMOLOGISTA</h4>
                        <p class="text-sm text-gray-500 mb-2">Consulta M√©dica</p>
                        <div class="mt-2 text-teal-700 font-bold text-xl">R$ 150,00</div>
                    </div>
                </div>
            </div>

            <!-- ETAPA 2: DATA -->
            <div id="step-2" class="mb-10 hidden">
                <div class="flex items-center gap-4 mb-6">
                    <div class="w-10 h-10 rounded-full bg-teal-600 text-white flex items-center justify-center font-bold">2</div>
                    <h3 class="text-xl font-bold text-slate-800">Escolha a Data (2026)</h3>
                </div>
                <div class="max-w-xs mx-auto md:mx-0">
                    <input type="date" id="date-input" onchange="handleDateChange()" min="2026-01-01" max="2026-12-31" class="w-full p-4 border border-gray-300 rounded-xl focus:ring-2 focus:ring-teal-500 outline-none bg-white font-medium shadow-sm">
                    <p id="date-error" class="text-red-500 text-sm mt-2 hidden font-bold"></p>
                </div>
            </div>

            <!-- ETAPA 3: HOR√ÅRIOS -->
            <div id="step-3" class="mb-10 hidden">
                <div class="flex items-center gap-4 mb-6">
                    <div class="w-10 h-10 rounded-full bg-teal-600 text-white flex items-center justify-center font-bold">3</div>
                    <h3 class="text-xl font-bold text-slate-800">Selecione o Hor√°rio</h3>
                </div>
                <div id="slots-container" class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-6 gap-3"></div>
            </div>

            <!-- ETAPA 4: DADOS FINAIS -->
            <div id="step-4" class="hidden border-t border-gray-100 pt-8">
                <div class="flex items-center gap-4 mb-6">
                    <div class="w-10 h-10 rounded-full bg-teal-600 text-white flex items-center justify-center font-bold">4</div>
                    <h3 class="text-xl font-bold text-slate-800">Finalizar Agendamento</h3>
                </div>
                <form onsubmit="finishBooking(event)" class="space-y-4">
                    <input type="text" id="client-name" required placeholder="Nome Completo do Paciente" class="w-full p-4 border rounded-xl outline-none focus:ring-2 focus:ring-teal-500 shadow-sm">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <input type="tel" id="client-phone" required placeholder="WhatsApp com DDD" class="p-4 border rounded-xl outline-none focus:ring-2 focus:ring-teal-500 shadow-sm">
                        <input type="text" id="client-city" placeholder="Sua Cidade" class="p-4 border rounded-xl outline-none focus:ring-2 focus:ring-teal-500 shadow-sm">
                    </div>
                    <button type="submit" id="btn-confirm" class="w-full bg-teal-600 hover:bg-teal-700 text-white font-bold py-5 rounded-2xl shadow-xl transition-all flex items-center justify-center gap-3 text-lg mt-4">
                        ‚úÖ Confirmar Agendamento no WhatsApp
                    </button>
                    <p class="text-xs text-center text-gray-400 mt-2">Voc√™ ser√° redirecionado para o WhatsApp da cl√≠nica para valida√ß√£o final.</p>
                </form>
            </div>

        </div>
    </main>

    <!-- RODAP√â -->
    <footer class="bg-teal-900 text-teal-100 py-12 text-center mt-12">
        <div class="container mx-auto px-6">
            <svg class="w-12 h-12 text-teal-500 mx-auto mb-4 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
            </svg>
            <p class="text-lg font-bold tracking-widest uppercase">Consult√≥rio Olharys</p>
            <p class="text-sm opacity-60 mt-2 italic">Qualidade de vis√£o ao seu alcance.</p>
            <div class="mt-6 pt-6 border-t border-teal-800 text-xs opacity-40">
                &copy; 2026 Todos os direitos reservados.
            </div>
        </div>
    </footer>

</body>
</html>
